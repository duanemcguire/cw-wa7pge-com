{% extends 'base.html' %}
    
{% block content %}
    
<style>
    button {margin-bottom: 4px;}
    @media (max-width: 768px) {
        #hotkeys {
            display: none;
        }
    }
</style>
<script src="/static/js/jscwlib.js"></script>

<div class="content" >
    <h2>Phrase Flow / IFR</h2>
    
    <div style="float: left">
        <form method="GET" id='theForm' >
            Category: <select name="category" id='category' style="max-width: 200px;">
                {% for category in categories %}
                    {% if category != 'Word' and category != 'Experimental'  and category != 'Pangram' %}
                        <option value="{{ category }}" {% if category==selected_category %}selected{% endif %}>{{ category }}</option>
                    {% endif %}    
                {% endfor %}
            </select>        

            Collection: <select id="selectCollection" name="filename" style="width: 200px;">
                {% for file in files %}
                    <option value="{{ file }}" {% if file == selected_file %}selected{% endif %}>{{ file }}</option>
                {% endfor %}
            </select>

            WPM: 

        <select name="wpm" id="wpm" style="width: 150px;" >
            {% for wpm_option in attr.wpm_options %} 
                <option value="{{wpm_option}}" {% if wpm_option == attr['wpm'] %}selected{% endif %}>{{wpm_option}} </option>
            {% endfor %}
        </select>    


        Repetitions: <select name="repititions" id="repititions" style="width: 150px;" >
            <option value="1">1</option>
            <option value="2" {% if attr['repititions'] == '2' %} selected {% endif %}>2</option>
            <option value="3" {% if attr['repititions'] == '3' %} selected {% endif %}>3</option>
        </select>

        Word Spacing: <select name="ws" id="ws" style="width: 150px;" >
             {% for ws_option in attr.ws_options %} 
                <option value="{{ws_option}}" {% if ws_option == attr['ws'] %}selected{% endif %}>{{ws_option}} {% if ws_option == "1" %} (Standard) {% endif %}</option>
            {% endfor %}
        </select>
<span><span id="wordSpace"></span> ms</span>
        <BR>
        <input type="hidden" name="newCategory" id="newCategory" value = "0">

        </form>
        
        <button id="buttonPlayCW"  ">Play</button>
        <button id="buttonStopCW"  ">Stop</button>
        <BR>
    
    </div>
    <div style="margin: 5px; float: left; border: 1px solid black; padding: 3px; background-color: #eeeeee; max-width: 600px;" >
        <H2>Phrase Flow / Instant Flow Recovery</H2>
        This is a phrase flow and Instant Flow Recovery (IFR) exercise. Go with the flow. Focus on forward motion.   
        If a word is missed, ignore it. Focus on catching the next word. 
        <BR><BR>

            The initial setting is 20 wpm with standard word spacing (420 milliseconds). 
        <BR><BR>            

        Set the phrase collection, WPM, and word spacing so that you are missing some but not all of the words as they flow by. 
        That difficulty level will be the sweet spot for improving your flow recovery skills.  
        <BR><BR>    
        If you change the repetitions to 2 or 3, you may confirm your recognition by listening again.
        
    </div>


</div>
    

 <script>

/* ===============================
   Constants
================================ */
const repEl = document.getElementById('repititions')
const wpmEl = document.getElementById('wpm')
const wsEl = document.getElementById('ws')
category = document.getElementById('category');

/* ===============================
   CW Player State
================================ */

let player = null;
let running = false;
let nextTimeout = null;
let lines = {{ lines | safe }};
let prefix = 'VVV  ';
let lastLine = '';
let repcount = 0;
let repititions = {{ attr['repititions'] }};
document.getElementById('wordSpace').innerText = getWordSpace();

/* ===============================
   Initialization
================================ */

function initPlayer() {
    if (player) return;

    player = new jscw();
    player.init();

    player.onFinished = playNext;
}

/* ===============================
   Play / Stop Controls
================================ */

function startCW() {
    if (running) return;

    running = true;
    prefix = 'VVV  ';
    initPlayer();
    playNext();
}

function stopCW() {
    running = false;


    if (player) {
        player.stop();

        // Close AudioContext if exposed (Android friendly)
        if (player.context && player.context.state !== 'closed') {
            player.context.close();
        }

        player = null;
    }
}

/* ===============================
   Playback Loop
================================ */

function playNext() {
    if (!running || !player) return;

    const speed = Number(wpmEl.value);
    player.setWpm(speed);
    player.setEws(getEWS());

    const word = getLine();
    console.log(word);
    player.play(prefix + " " + word + " ");
    prefix = "  =   ";

}


/* ===============================
   Helpers
================================ */

function getWordSpace() {
    const speed = Number(wpmEl.value);
    const ws = Number(wsEl.value);
    const spacing = Math.floor(8400 * ws / speed);

    document.getElementById('wordSpace').innerText = spacing;
    return spacing;
}

function getLine() {
    repcount++;
        let line = null;
        let lastline = null;
        if (repcount >= repititions) {
            randomIndex = Math.floor(Math.random() * lines.length);
            line = lines[randomIndex].trim().replace("~"," ")
            line = line.replace("("," = ")
            line = line.replace(")"," = ")
            line = line.replace("/n","")
            lastline = line;
            repcount = 0; 
        } else {
            line = lastline;
        }
    return line;
}

function display_title(){
    document.getElementById("reveal_title").innerText = song_title;
    document.getElementById("reveal_title").style.display = "block";
}

function getEWS(){
    return wsEl.options[wsEl.selectedIndex].value - 1;
        
}



/* ===============================
   Event Wiring
================================ */

buttonPlayCW.addEventListener('click', startCW);
buttonStopCW.addEventListener('click', stopCW);

repEl.addEventListener('change', () => {
    repititions = Number(repEl.value);
});

wpmEl.addEventListener('change', getWordSpace);
wsEl.addEventListener('change', getWordSpace);

category.addEventListener('change', () => {
        newCategory = document.getElementById('newCategory');
        newCategory.value = 1;        
        theForm.submit();
    });


selectCollection.addEventListener('change', () => {
    theForm.submit();
});



</script>
{% endblock %}