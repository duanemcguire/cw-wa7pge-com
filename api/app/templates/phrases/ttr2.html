{% extends 'base.html' %}
    
{% block content %}
    
<style>
    button {margin-bottom: 4px;}
    @media (max-width: 768px) {
        #hotkeys {
            display: none;
        }
    }
</style>
<script src="api/app/static/js/jscwlib.js"></script>

<div class="content" >
    <h2>Word flow/TTR</h2>
    <div style="float: left">
        <form method="GET" id='theForm' >
            Word Collection: <select id="selectCollection" name="filename" style="width: 200px;">
                {% for file in files %}
                    <option value="{{ file }}" {% if file == selected_file %}selected{% endif %}>{{ file }}</option>
                {% endfor %}
            </select>

            WPM: 

        <select name="wpm" id="wpm" style="width: 150px;" >
            {% for wpm_option in attr.wpm_options %} 
                <option value="{{wpm_option}}" {% if wpm_option == attr['wpm'] %}selected{% endif %}>{{wpm_option}} </option>
            {% endfor %}
        </select>    

        Word Spacing: <select name="ws" id="ws" style="width: 150px;" >
             {% for ws_option in attr.ws_options %} 
                <option value="{{ws_option}}" {% if ws_option == attr['ws'] %}selected{% endif %}>{{ws_option}} {% if ws_option == "1" %} (Standard) {% endif %}</option>
            {% endfor %}
        
        </select><span><span id="wordSpace">420</span> ms</span>
        <BR>
        <input type="hidden" name="newCategory" id="newCategory" value = "0">

        </form>
        
        <button id="buttonPlayCW"  ">Play</button>
        <button id="buttonStopCW"  ">Stop</button>
        <BR>
        <div class="line-display" id="reveal_title" style="display:block; font-size: 3em; padding: 5px; float: left;" ></div>    
        <div class="line-display" id="reveal_title" style="display:block; font-size: 3em; padding: 5px; float: left; color: white" >|</div>    
    </div>
    <div style="margin: 5px; float: left; border: 1px solid black; padding: 3px; background-color: #eeeeee; max-width: 600px;" >
        <H2>Time To Recognize / TTR Version 2</H2>
        This version of the TTR exercise eliminates the option of flashing the word after it is sounded. Go with the flow. Focus on forward motion.   
        If a word is missed, ignore it. Focus on catching the next word. 
        Because the words are presented randomly, and without context, you may find this to be 
        a good environment for improving your Instant Flow Recovery (IFR).<BR><BR>
        The initial setting is 20 wpm with standard word spacing. At 20 wpm, the standard space between words is 420 milliseconds. 
        <BR><BR>    
        <a href="/phrases/ttr">Version 1</a> is also available.   
    </div>


</div>
    

 <script>
    const player = new jscw();
    const wpmEl = document.getElementById('wpm')
    const wsEl = document.getElementById('ws')
    const revealEl = document.getElementById('reveal')

    let lines = {{lines | safe}};
    let prefix = 'VVV  '
    let line = '';
    let displayTime = 1000;
    let wordSpace = 420;
    let stop = false;

    function play_cw(){
        if (! stop) {
            player.init();
            wordSpace = getWordSpace();
            player.setWpm(speed);
            line = getLine();
            player.onFinished = display_line;
            player.play(prefix + " " + line);
            prefix = "";
        }    
    }

    function stop_cw(){
        stop = true;
        player.stop();
    }

    function display_line(){
        setTimeout(() => {
               play_cw();
        },wordSpace);    
    }

    function getWordSpace(){
        speed = wpmEl.options[wpmEl.selectedIndex].value
        ws = wsEl.options[wsEl.selectedIndex].value
        w = Math.floor(8400*ws/speed) 
        return w
    }

    function getLine(){
        randomIndex = Math.floor(Math.random() * lines.length);
        line = lines[randomIndex].trim().replace("~"," ")
        line = line.replace("("," = ")
        line = line.replace(")"," = ")
        line = line.replace("/n","") 
        return line;
    }


    buttonPlayCW.addEventListener('click', () =>{
        stop = false;
        play_cw(line)
    });

    buttonStopCW.addEventListener('click', () =>{
        stop_cw()
    });

    wpmEl.addEventListener('change', function(event) {
        document.getElementById('wordSpace').innerText = getWordSpace();
    });

    wsEl.addEventListener('change', function(event) {
        document.getElementById('wordSpace').innerText = getWordSpace();
    });
    selectCollection.addEventListener('change', () => {
        theForm.submit();
    });


</SCRIPT>    
{% endblock %}